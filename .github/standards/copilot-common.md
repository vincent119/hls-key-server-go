# Copilot 共用規範（copilot-common.md）

> 本檔為所有 Copilot 規範的共用基底。
> 語言／工具專用檔（例如 `go.instructions.md`, `yaml.instructions.md`, `pulumi.instructions.md`）**必須**在開頭宣告：
>
> - 本檔延伸自：`.github/standards/copilot-common.md`
> - 詞彙映射：`.github/standards/copilot-vocabulary.yaml`
>
> 語言專用檔只補充該語言／工具「特有」規範，不得重複本檔內容。

---

## 目標與適用範圍

- 以**正確性優先**為原則，產出**可編譯、可測試、可部署（production-ready）**的
  最小安全變更（Minimal, Safe, Complete Change）。
- 降低重複、統一風格、提高可維護性，讓所有語言專用檔共享一致基準。

---

## 1. 縮排與格式（Formatting）

- **縮排規則**：`1 個 Tab = 2 個空白`。編輯器應設定為按下 Tab 輸出 2 空白（soft tab）。
- **編碼**：UTF-8（無 BOM）。
- **換行**：LF (`\n`)。檔尾保留單一換行。
- **行寬**：建議 100～120 字元；超過請換行或抽取函式。
- **空白與註解**：移除行尾多餘空白；區塊間以 1 空白行分隔邏輯段落。
- **語言專用格式化**：**必須**使用該語言官方／業界標準工具（例如：`gofmt` / `goimports`、`black`、`prettier`、`yamlfmt`…）。
  - 僅對**該語言檔型**執行：例如 `gofmt`/`goimports` 只作用於 `*.go`，不可套用於 `.md`/`.yaml`。
  - 語言專用檔需列出實際指令與版本需求。

---

## 2. 檔案與資料夾操作規則（File Ops）

- **禁止自動重建專案骨架**：除非明確要求，不得建立新專案或重排目錄結構。
- **禁止產生重複檔**：不得新增第二份 `LICENSE`、`README`、`CODEOWNERS`、`CONTRIBUTING`、
  `SECURITY.md` 等共用文件。
- **變更邊界**：只修改**與需求直接相關**的檔案與段落；避免不相干的大面積重排。
- **相容性**：不得移除或破壞既有公開介面／對外合約，除非需求明確同意並提供遷移指引。
- **二進位與大型檔**：不得加入產生物、快取、資料庫 dump、秘密金鑰、機敏資料。
- **檔名與大小寫**：遵循現有專案慣例（kebab/camel/snake）；跨平台相容（避免大小寫衝突）。
- **I/O 安全**：新增檔案時同步更新 `.gitignore`、`LICENSE` header（若專案要求）、與任何清單／索引檔。

---

## 3. 智慧產生行為（Generation Behavior）

- **最小且完整**：偏好小變更，但必須包含通過編譯與測試所需的**全部**修補（含必要新增檔）。
- **不可臆測 API**：不得虛構不存在的函式、型別或第三方套件；若需新依賴，**明列版本與用途**並評估風險。
- **詞彙一致**：所有中英術語與命名遵循 `.github/copilot-vocabulary.yaml`；遇衝突以詞彙檔為準。
- **計算與效能**：移除重複計算與多餘 I/O／配置；優先 O(1)/O(n) 解；避免不必要的反射、全域狀態、非必要鎖。
- **可觀測性**：延用現有 logger/metrics/tracing 介面；新程式碼需具備基本可觀測性鉤子（如關鍵路徑計時、錯誤標籤）。
- **失敗預設安全**：錯誤處理採 fail-fast 與明確回傳；避免吞錯；針對 I/O、網路、外部服務加入重試與退避（語言專用檔可細化）。
- **文件先行**：對外行為、限制與副作用必須在註解／README 區塊說明（見第 4 節）。

---

## 4. 註解與文件規範（Comments & Docs）

- **目的性註解**：註解說明「為何這樣做」與邊界條件，而非重述程式碼字面。
- **逐行中文註解**：當需求明確要求時，對**關鍵變更區塊**提供逐行中文註解（邏輯密度高／錯誤風險高處必備）。
- **公開介面文件**：所有公開函式／型別／模組需有摘要、參數、回傳值、錯誤情境與範例（若適用）。
- **TODO / FIXME 標記**：採統一樣式 `// TODO(scope): 說明 (#issue)`；不可留無時限的 TODO，需附追蹤票。
- **變更說明**（變更檔頭或 PR 描述需包含）：
  - **為何這樣做**：背景、替代方案、取捨。
  - **影響範圍**：受影響模組、向下相容性、部署／運維注意。
  - **風險與緩解**：已加的防護（feature flag、回滾策略、觀測指標）。
  - **測試證明**：單元／整合測試、基準測試、手動驗證步驟與結果。

---

## 5. 正確性與可編譯（Build & Tests）

- **可編譯**：提交前必須通過編譯／組建（含必要的 codegen／schema 驗證）。
- **靜態檢查**：必須通過 linters／格式化檢查；語言專用檔列出工具與最低版本。
- **測試**：
  - 新增或修改核心邏輯時，**必須**具備單元測試；跨模組互動則加整合測試。
  - 測試數據最小化且可重現；禁止使用機敏資料。
  - 關鍵路徑應有**至少一個失敗案例**與**邊界條件**（空輸入、極端值、錯誤回傳）。
- **效能**：對熱路徑改動，提供基準測試或量測數據；避免退步，必要時加基準守門（benchmark threshold）。

---

## 6. 安全與合規（Security & Compliance）

- 不得硬編碼 secrets／tokens／憑證；改用現有祕密管理機制。
- 禁止引入非相容授權的第三方套件；新增依賴需標注授權並通過審查。
- 個資／敏感資料需遮罩與最小化輸出；日誌不得洩漏機敏資訊。
- 外部輸入一律視為不可信：做輸入驗證與輸出編碼；避免命令注入、SQL/LDAP 注入等。

---

## 7. 與詞彙檔整合（Vocabulary）

- 詞彙對應統一存放於 **`.github/copilot-vocabulary.yaml`**。
  命名、注釋與文件中的術語應以此檔為準；若現有程式碼不同，需在變更說明中註明並提供過渡策略。
- 語言專用檔開頭須指示 Copilot：「載入本檔時，同步套用 `.github/copilot-vocabulary.yaml` 的對應關係」。
  - 詞彙為**權威來源**；若與現有命名衝突，依 `conflicts.policy` 提供別名一版、標註棄用並附遷移說明。

---

## 8. Review Checklist（提交前自檢）

在提交 PR／變更前，逐項確認（✅=通過／❌=未通過）：

1. **正確性**：需求覆蓋完整；輸入／輸出與副作用符合預期（含錯誤路徑）。
2. **可編譯**：本地或 CI 已通過 build／codegen／schema 檢查。
3. **測試充分**：單元／整合／邊界測試齊備且綠燈；關鍵路徑含失敗案例。
4. **格式一致**：已跑格式化與 linters；無行尾空白；行寬適當。
5. **最小變更**：只動到必要檔案與區塊；無不相干重排。
6. **詞彙一致**：命名與術語符合 `.github/copilot-vocabulary.yaml`。
7. **效能與資源**：消弭重複計算／多餘配置；無明顯退步；必要時附基準。
8. **可觀測性**：關鍵路徑具備合理 log／metrics／tracing；不洩漏機敏資訊。
9. **安全合規**：無 secrets／敏感資料；新依賴含授權審視。
10. **變更說明**：已在檔頭或 PR 描述清楚交代「為何」「影響」「風險與替代」。
11. **禁止重複檔**：未新增第二份 `LICENSE/README/...` 等共用文件。
12. **部署思考**：需要的遷移腳本、feature flag、回滾步驟與驗證手冊已備妥。

---

## 11. 驗證指令示例（跨語言）

> 僅對應正確檔型執行，避免把 Markdown/YAML 當作程式碼格式化。

- Go：
  - `gofmt -s -w $(git ls-files '*.go')`
  - `goimports -w $(git ls-files '*.go')`
  - `go vet ./...`
  - `golangci-lint run ./...`
  - `go test -race -count=1 ./...`
  - `go mod tidy`
- Markdown（可選）：`markdownlint`
- YAML（可選）：`yamllint`

> 可於 Makefile/CI 封裝為 `fmt`/`lint`/`vet`/`test` 目標，僅匹配對應檔型。

## 9. 版本與工具相容（Compatibility）

- 所有工具（語言版本、編譯器、格式化器、linters、打包器）需在語言專用檔列明**最低版本**與**安裝指令**。
- 變更導入新工具或升級版本時，**必須**在變更說明列出影響面與遷移步驟。

---

## 10. PR 描述模板（建議）

> 可在 repo `.github/pull_request_template.md` 引用本段

**背景 / 為何**：
**做了什麼**（最小且完整）：
**替代方案與取捨**：
**影響範圍**（相容性 / 部署 / 運維）：
**風險與緩解**（flag / 回滾 / 監控）：
**測試證明**（單元 / 整合 / 邊界 / 基準）：
**效能觀測**（若適用）：
**詞彙一致性**（是否符合 vocabulary）：

---

### 附錄 A：常見誤用（請避免）

- 一次改動太多無關檔案、為了美觀做大規模重排。
- 虛構不存在的 API 或第三方套件名稱。
- 加入第二份通用文件（`LICENSE/README` 等）。
- 測試僅涵蓋成功路徑，無失敗或邊界案例。
- 忽略現有 logger/metrics，導致無法觀測新邏輯。
- 將 secrets 寫入程式碼或測試樣本。

---

> **實施說明（供維護者）**
>
>
> - 提交本檔至 `.github/standards/copilot-common.md`。
> - 建立 `.github/standards/copilot-vocabulary.yaml`（術語映射；各語言檔需「指向此檔」）。
> - 各語言／工具專用檔在開頭加入「延伸自本檔與 vocabulary」的宣告，並**刪除**與本檔重複規範。
> - CI 加入：格式化、lint、編譯、測試、重複檔檢查與（若有）基準退步守門。
